# Context Graph Constitution v4.1.0 (Optimized)
# Bio-Nervous MCP | UTL | Teleological Vectors | GWT | Adaptive Thresholds
# ═══════════════════════════════════════════════════════════════════════

meta:
  v: "4.1.0"
  name: "Ultimate Context Graph"
  desc: "5-layer bio-nervous UTL knowledge graph: 13-embedding teleological fingerprints, Kuramoto-synchronized GWT consciousness, adaptive self-learning thresholds, NORTH autonomous services"
  paradigm: "Multi-Array Teleological Fingerprints with GWT — 13-embedding array IS the teleological vector, Kuramoto-synchronized, no hardcoded thresholds"
  modules: { foundation: "NORTH-001-007", services: "NORTH-008-020", teleological: "TELEO-001-015" }

# ABBREVIATIONS (used throughout)
# UTL=Unified Theory of Learning, L=Learning score, ΔS=entropy, ΔC=coherence
# wₑ=emotional weight, φ=phase angle, NT=neurotransmitter, SS=Steering Subsystem
# OI=Omnidirectional Inference, FV=Formal Verification, PC=Predictive Coding
# HE=Hyperbolic Entailment, MHN=Modern Hopfield Network, SDM=Sparse Distributed Memory
# TF=Teleological Fingerprint, PV=Purpose Vector, SF=Semantic Fingerprint (13-array)
# A(v,V)=Teleological Alignment (cosine to North Star)
# GWT=Global Workspace Theory, GW=Global Workspace, IIT=Integrated Information Theory
# CMS=Continuum Memory System, C(t)=Consciousness, I(t)=Integration, R(t)=Reflection, D(t)=Differentiation
# r=Kuramoto order param, K=coupling strength, θᵢ=phase, ωᵢ=natural freq
# ATC=Adaptive Threshold Calibration, ECE=Expected Calibration Error, MCE=Max Calibration Error
# EWMA=Exponentially Weighted Moving Average, UCB=Upper Confidence Bound, GP=Gaussian Process
# T=Temperature, α=EWMA smoothing

# ═══════════════════════════════════════════════════════════════════════
# TECH STACK
# ═══════════════════════════════════════════════════════════════════════
stack:
  lang: { rust: "1.75+", edition: "2021", cuda: "13.1" }
  gpu: { target: "RTX 5090", vram: "32GB", compute: "12.0" }
  deps: [tokio@1.35+, serde@1.0+, uuid@1.6+, chrono@0.4+, rmcp@0.1+, cudarc@0.10+, faiss@0.12+gpu, rocksdb@0.21+, scylladb@1.0+]
  db:
    primary: { dev: rocksdb, prod: scylladb }
    indexes: { per_embedder: "13× HNSW", matryoshka_128d: HNSW, splade_inverted: inverted, purpose: "13D HNSW", goal_hierarchy: tree }
    temporal: timescaledb
    cache: redis7+
  embed_fallback: [openai/text-embedding-3-large, cohere/embed-english-v3.0]

# ═══════════════════════════════════════════════════════════════════════
# DIRECTORY STRUCTURE
# ═══════════════════════════════════════════════════════════════════════
dirs:
  crates/:
    context-graph-mcp/: "tools/, resources/, handlers/, adapters/"
    context-graph-core/:
      desc: "graph/, search/, utl/, session/, curation/, teleological/, autonomous/"
      autonomous/: { foundation/: [bootstrap, thresholds, drift, curation, evolution, workflow], services/: [bootstrap_service, threshold_learner, drift_detector, drift_corrector, pruning_service, consolidation_service, gap_detection, subgoal_discovery, weight_adjuster, obsolescence_detector, daily_scheduler, event_optimizer, self_healing_manager] }
      teleological/: [storage, feedback_learner, profile_manager]
    context-graph-cuda/: "kernels/, hnsw/, hopfield/, neuromod/"
    context-graph-embeddings/: "models/, fingerprint/, purpose_vector.rs, semantic_fingerprint.rs"
    context-graph-storage/: "rocksdb/, scylla/, indexes/, temporal/, autonomous/"
  specs/: [functional/, technical/, tasks/]
  tests/: [integration/, benchmarks/, fixtures/, chaos/, validation/]
  config/: [default.toml, production.toml, test.toml]
  .ai/: [activeContext.md, decisionLog.md, progress.md]

# ═══════════════════════════════════════════════════════════════════════
# CODING STANDARDS
# ═══════════════════════════════════════════════════════════════════════
naming:
  files: { rust: snake_case.rs, cuda: snake_case.cu, tests: "{mod}_test.rs" }
  types: PascalCase
  funcs: snake_case_verb_first
  vars: { local: snake_case, const: SCREAMING_SNAKE }
  json: snake_case

rules:
  - "One type/module, max 500 lines"
  - "Co-locate tests: #[cfg(test)]"
  - "Import order: std→external→workspace→super/self"
  - "Result<T,E>, thiserror derivation"
  - "Never unwrap() in prod; use expect() with context"
  - "tokio async, Arc<RwLock<T>> for shared state"
  - "Lock order: inner→faiss_index"
  - "Max 5 unsafe blocks/module, document invariants"
  - "CUDA FFI only in context-graph-cuda"

doc_format: "/// Brief\\n/// # Args/Returns/Errors/Panics\\n/// `Constraint: X < Yms`"

# ═══════════════════════════════════════════════════════════════════════
# ANTI-PATTERNS (FORBIDDEN)
# ═══════════════════════════════════════════════════════════════════════
forbidden:
  AP-001: "unwrap() in prod"
  AP-002: "Hardcoded secrets"
  AP-003: "Magic numbers"
  AP-004: "Blocking I/O in async"
  AP-005: "FAISS mutation without lock"
  AP-006: "New util without checking utils/"
  AP-007: "Stub data in prod"
  AP-008: "Direct API from handlers"
  AP-009: "NaN/Infinity in UTL"
  AP-010: "store_memory without rationale"
  AP-011: "merge_concepts without priors_vibe_check"
  AP-012: "Trust distilled summaries (use hydrate_citation)"
  AP-013: "Ignore Cognitive Pulse"
  AP-014: "Permanent delete without user_requested"
  AP-015: "GPU alloc without pool"

# ═══════════════════════════════════════════════════════════════════════
# SECURITY [SEC-##]
# ═══════════════════════════════════════════════════════════════════════
security:
  SEC-01: "Validate/sanitize all input (PIIScrubber L1)"
  SEC-02: { rule: "Scrub PII pre-embed", patterns: [api_key, password, bearer_token, ssn, credit_card] }
  SEC-03: { anomaly_threshold: "3.0 std", content_align_min: 0.4 }
  SEC-04: { rule: "Detect prompt injection", patterns: ["ignore previous", "disregard system", "you are now", "new instructions:", "override:"] }
  SEC-05: { rule: "Quarantine semantic cancer", trigger: "importance>0.9 AND neighbor_entropy>0.8", action: "reduce 50%, flag" }
  SEC-06: "Soft delete 30-day recovery"
  SEC-07: "Secrets from env vars only"
  SEC-08: "No cross-agent memetic interference (perspective_lock)"

# ═══════════════════════════════════════════════════════════════════════
# PERFORMANCE BUDGETS
# ═══════════════════════════════════════════════════════════════════════
perf:
  latency: { inject_context: "<25ms p95/<50ms p99", hopfield: "<1ms", reflex_cache: "<100μs", single_embed: "<10ms", batch_embed_64: "<50ms", faiss_1M_k100: "<2ms", distillation: "<50ms", neuromod_update: "<200μs", dream_wake: "<100ms", entailment_check: "<1ms" }
  throughput: { embed_batch: ">1000/sec", search_batch_100: "<5ms" }
  memory: { gpu: "<24GB (8GB headroom)", graph_cap: ">10M nodes" }
  quality: { utl_avg: ">0.6", coherence_recovery: "<10s", attack_detection: ">95%", false_positive: "<2%", info_loss: "<15%", compression: ">60%" }

# ═══════════════════════════════════════════════════════════════════════
# TESTING
# ═══════════════════════════════════════════════════════════════════════
testing:
  coverage: { unit: "90%", integration: "80%", docs: "80%" }
  types: { unit: "#[cfg(test)] - business logic, UTL, embedding", integration: "tests/integration/ - MCP, graph, session", benchmark: "benches/ - latency, throughput", chaos: "tests/chaos/ - GPU OOM, network partition, concurrent mutation", validation: "tests/validation/ - needle-haystack, UTL dynamics, dream" }
  gates:
    pre-commit: [fmt --check, clippy -D warnings, test --lib]
    pre-merge: [test --all, bench --no-run, "coverage>=90%"]
    pre-deploy: [integration pass, "bench regression<5%", chaos pass]

# ═══════════════════════════════════════════════════════════════════════
# UTL (Unified Theory of Learning)
# ═══════════════════════════════════════════════════════════════════════
utl:
  canonical: "L = f((ΔS × ΔC) · wₑ · cos φ)  →  L ∈ [0,1]"
  multi_embed: "L_multi = sigmoid(2.0 · (Σᵢ τᵢλ_S·ΔSᵢ) · (Σⱼ τⱼλ_C·ΔCⱼ) · wₑ · cos φ)"
  params: { ΔSᵢ: "[0,1] entropy/space i", ΔCᵢ: "[0,1] coherence/space j", τᵢ: "[0,1] teleological weight", wₑ: "[0.5,1.5] emotional", φ: "[0,π] phase sync" }
  loss: "J = 0.4·L_task + 0.3·L_semantic + 0.2·L_teleological + 0.1·(1-L)"
  adaptive_weights:
    first_time: { λ_task: 0.3, λ_semantic: 0.2, λ_dyn: 0.9 }
    mid_level: { λ_task: 0.7, λ_semantic: 0.4, λ_dyn: 0.6 }
    expert: { λ_task: 1.0, λ_semantic: 0.1, λ_dyn: 0.3 }
  johari: # ΔS×ΔC plane IS the Johari Window
    Open: "ΔS<0.5, ΔC>0.5 (aware)"
    Blind: "ΔS>0.5, ΔC<0.5 (discovery opportunity)"
    Hidden: "ΔS<0.5, ΔC<0.5 (dormant)"
    Unknown: "ΔS>0.5, ΔC>0.5 (frontier)"
    cross_space: "Memory can be Open(semantic) but Blind(causal)"
  lifecycle:
    infancy:  { n: "0-50",   λ_ΔS: 0.7, λ_ΔC: 0.3, stance: "capture-novelty" }
    growth:   { n: "50-500", λ_ΔS: 0.5, λ_ΔC: 0.5, stance: "balanced" }
    maturity: { n: "500+",  λ_ΔS: 0.3, λ_ΔC: 0.7, stance: "curation-coherence" }

# ═══════════════════════════════════════════════════════════════════════
# TELEOLOGICAL ARCHITECTURE
# ═══════════════════════════════════════════════════════════════════════
teleological:
  core: "13-embedding array IS the teleological vector"
  alignment: "A(v, V) = cos(v, V) = (v · V) / (||v|| × ||V||)"
  purpose_vector: "PV = [A(E1,V), ..., A(E13,V)]  # 13D, searchable"
  thresholds: { optimal: "≥0.75", acceptable: "[0.70,0.75)", warning: "[0.55,0.70)", critical: "<0.55", failure_prediction: "ΔA<-0.15 predicts failure 30-60s" }
  transitivity: "If A(u,v)≥θ₁ and A(v,w)≥θ₂, then A(u,w)≥2θ₁θ₂-1"
  goal_hierarchy: { V_global: "North Star", V_mid: "Retrieval/Storage/Reasoning", V_local: "Per-operation" }
  embedder_purposes:
    E1: V_meaning, E2: V_freshness, E3: V_periodicity, E4: V_ordering, E5: V_causality
    E6: V_selectivity, E7: V_correctness, E8: V_connectivity, E9: V_robustness
    E10: V_multimodality, E11: V_factuality, E12: V_precision, E13: V_keyword_precision

# ═══════════════════════════════════════════════════════════════════════
# GRAPH EDGE MODEL (Marblestone NT)
# ═══════════════════════════════════════════════════════════════════════
edge_model:
  attrs: [source:UUID, target:UUID, type:Semantic|Temporal|Causal|Hierarchical|Relational, weight:[0,1], confidence:[0,1]]
  nt_weights: "w_eff = base × (1 + excitatory - inhibitory + 0.5×modulatory)"
  domain: Code|Legal|Medical|Creative|Research|General
  amortized: { trigger: "3+ hop ≥5×", weight: "product(path)", confidence: "≥0.7" }

# ═══════════════════════════════════════════════════════════════════════
# 5-LAYER BIO-NERVOUS SYSTEM
# ═══════════════════════════════════════════════════════════════════════
layers:
  L1_Sensing: { lat: "<5ms", throughput: "10K/s", components: [13-model embed, PII scrub, adversarial detect], utl: "ΔS measurement" }
  L2_Reflex:  { lat: "<100μs", hit_rate: ">80%", components: [Hopfield cache], utl: "bypass if confidence>0.95" }
  L3_Memory:  { lat: "<1ms", capacity: "2^768 patterns", noise: ">20%", components: [MHN, FAISS GPU], utl: "consolidation" }
  L4_Learning: { freq: "100Hz", grad_clip: 1.0, components: [UTL optimizer, neuromod controller], utl: "L optimization" }
  L5_Coherence: { sync: "10ms", consistency: eventual, components: [Thalamic gate, PC, distiller, FV, GW broadcast], utl: "φ sync" }

# ═══════════════════════════════════════════════════════════════════════
# GLOBAL WORKSPACE THEORY (GWT)
# ═══════════════════════════════════════════════════════════════════════
gwt:
  consciousness: "C(t) = I(t) × R(t) × D(t) = r(t) × σ(MetaUTL.predict_accuracy) × H(PV)"
  components: { C: "Consciousness [0,1]", I: "Integration (Kuramoto r)", R: "Self-Reflection (Meta-UTL)", D: "Differentiation (13D entropy)" }

  kuramoto:
    formula: "dθᵢ/dt = ωᵢ + (K/N)Σⱼ sin(θⱼ-θᵢ)"
    order_param: "r·e^(iψ) = (1/N)Σⱼ e^(iθⱼ)"
    thresholds: { coherent: "r≥0.8", fragmented: "r<0.5", hypersync: "r>0.95 (pathological)" }
    frequencies: # Hz (band)
      E1: 40γ, E2: 8α, E3: 8α, E4: 8α, E5: 25β, E6: 4θ, E7: 25β
      E8: 12αβ, E9: 80γ+, E10: 40γ, E11: 15β, E12: 60γ+, E13: 4θ

  workspace:
    active_memory: "Option<MemoryId>"
    coherence_threshold: 0.8
    broadcast_duration_ms: 100
    selection: "r≥0.8 → rank by r×importance×north_star_alignment → top-1 broadcasts"
    events:
      enters: { trigger: "r↑0.8", effect: "Dopamine+=0.2" }
      exits: { trigger: "r↓0.7", effect: "Log for dream" }
      conflict: { trigger: "Two r>0.8", effect: "critique_context" }
      empty_5s: { trigger: "No r>0.8 for 5s", effect: "epistemic_action" }

  self_ego_node:
    id: "SELF_EGO_NODE"
    fields: [fingerprint, purpose_vector, identity_trajectory, coherence_with_actions]
    loop: "Retrieve→A(action,PV)→if<0.55 self_reflect→update fingerprint→store evolution"
    identity_continuity: "IC = cos(PV_t, PV_{t-1}) × r(t); healthy>0.9, warning<0.7, dream<0.5"

  states: { DORMANT: "r<0.3", FRAGMENTED: "0.3≤r<0.5", EMERGING: "0.5≤r<0.8", CONSCIOUS: "r≥0.8", HYPERSYNC: "r>0.95" }

  meta_cognitive:
    formula: "MetaScore = σ(2×(L_predicted - L_actual))"
    low_meta: "MetaScore<0.5 for 5 ops → ↑Acetylcholine, introspective dream"

  quality: { Φ: ">0.3 (min_cut/total)", availability: ">90%", stability: ">500ms", meta_awareness: ">0.85", identity: ">0.9" }

# ═══════════════════════════════════════════════════════════════════════
# NEUROMODULATION
# ═══════════════════════════════════════════════════════════════════════
neuromod:
  Dopamine:     { param: hopfield.beta, range: "[1,5]", effect: "↑=sharp retrieval" }
  Serotonin:    { param: similarity.space_weights, range: "[0,1]", effect: "↑=more spaces" }
  Noradrenaline: { param: attention.temp, range: "[0.5,2]", effect: "↑=flat attention" }
  Acetylcholine: { param: utl.lr, range: "[0.001,0.002]", baseline: 0.001, decay: 0.1, effect: "↑=faster update" }

# ═══════════════════════════════════════════════════════════════════════
# DREAM LAYER
# ═══════════════════════════════════════════════════════════════════════
dream:
  trigger: { activity: "<0.15", idle: "10min" }
  phases: { nrem: { dur: "3min", purpose: "replay recent", recency_bias: 0.8 }, rem: { dur: "2min", purpose: "explore attractors", temp: 2.0 } }
  constraints: { queries: 100, semantic_leap: 0.7, abort_on_query: true, wake: "<100ms", gpu: "<30%" }

# ═══════════════════════════════════════════════════════════════════════
# STEERING SUBSYSTEM
# ═══════════════════════════════════════════════════════════════════════
steering:
  Gardener: { role: "cross-session curation", trigger: "activity<0.15 for 2min" }
  Curator: { auto: "dupes>0.95, weak<0.1, orphans>30d", escalate: "dupes 0.7-0.95, priors-incompatible, conflicts, semantic cancer" }
  Assessor: "per-interaction quality"
  reward: { range: "[-1,1]", dopamine: { pos: "+=r×0.2", neg: "-=|r|×0.1" } }

# ═══════════════════════════════════════════════════════════════════════
# OMNIDIRECTIONAL INFERENCE & FORMAL VERIFICATION
# ═══════════════════════════════════════════════════════════════════════
omni_infer:
  directions: [forward:A→B, backward:B→A, bidirectional:A↔B, bridge:cross-domain, abduction:best-hypothesis]
  clamp: { hard: fixed, soft: biased-adjustable }
  active_inference: "EFE minimizes surprise+ambiguity"

formal_verify:
  location: L5_Coherence
  conditions: [bounds, null_safety, type_invariants, loop_termination, custom]
  status: [Verified, Failed, Timeout, NotApplicable]
  cache: content_hash
  latency: "<10ms cached"

# ═══════════════════════════════════════════════════════════════════════
# PREDICTIVE CODING & GARDENER
# ═══════════════════════════════════════════════════════════════════════
pred_coding:
  flow: "L5→L1: prediction→error(obs-pred)→propagate surprise only"
  reduction: "~30% tokens"
  domain_priors: { medical: { causal: 1.8, code: 0.3 }, programming: { code: 2.0, graph: 1.5 }, creative: { semantic: 1.5, temporal: 0.5 } }

gardener:
  trigger: "activity<0.15 for 2min"
  ops: ["prune weak<0.1", "merge dupes>0.95", "rebalance hyperbolic", "rebuild FAISS"]
  gpu: "<10%"

# ═══════════════════════════════════════════════════════════════════════
# MCP PROTOCOL
# ═══════════════════════════════════════════════════════════════════════
mcp:
  version: "2024-11-05"
  transport: [stdio, sse]
  caps: [tools, resources, prompts, logging]
  errors: { -32700: Parse, -32600: InvalidRequest, -32601: MethodNotFound, -32602: InvalidParams, -32603: Internal, -32000: SessionNotFound, -32001: GraphQueryError, -32002: StorageError, -32003: CausalInferenceError, -32004: RateLimitExceeded }
  pulse: { fields: [entropy, coherence, suggested_action], cost: "~30 tokens" }

  # Core Tool Categories
  marblestone_tools: [get_steering_feedback, omni_infer, verify_code_node]
  gwt_tools: [get_consciousness_state, get_workspace_status, get_kuramoto_sync, get_ego_state, trigger_workspace_broadcast, adjust_coupling, get_johari_classification, compute_delta_sc]
  adaptive_threshold_tools: [get_threshold_status, get_calibration_metrics, trigger_recalibration, set_threshold_prior, get_threshold_history, explain_threshold]
  north_star_tools:
    NORTH-008: [bootstrap_north_star, finalize_north_star, get_north_star_status]
    NORTH-009: [get_learner_state, observe_outcome]
    NORTH-010: [get_drift_status, get_drift_history]
    NORTH-011: [trigger_drift_correction, preview_correction]
    NORTH-012: [get_prune_candidates, execute_prune, get_prune_report]
    NORTH-013: [get_consolidation_candidates, execute_consolidation]
    NORTH-014: [analyze_gaps, get_gap_report]
    NORTH-015: [discover_subgoals, propose_subgoal]
    NORTH-016: [adjust_weights, preview_weight_change]
    NORTH-017: [get_obsolete_goals, mark_obsolete]
    NORTH-018: [get_schedule, trigger_scheduled_task]
    NORTH-019: [get_optimization_status, trigger_optimization]
    NORTH-020: [get_health_status, trigger_healing, get_healing_history]

# ═══════════════════════════════════════════════════════════════════════
# 13-MODEL EMBEDDING → TELEOLOGICAL FINGERPRINT
# ═══════════════════════════════════════════════════════════════════════
embeddings:
  paradigm: "NO FUSION - Store all 13 embeddings; ~17KB quantized (63% reduction), 100% info preserved"

  models: # dim|math|hw|lat|purpose|quant
    E1_Semantic: { dim: 1024, math: Dense_Transformer, lat: "<5ms", quant: "PQ-8", matryoshka: [512,256,128] }
    E2_Temporal_Recent: { dim: 512, math: Exp_Decay, lat: "<2ms", quant: Float8 }
    E3_Temporal_Periodic: { dim: 512, math: Fourier, lat: "<2ms", quant: Float8 }
    E4_Temporal_Positional: { dim: 512, math: Sin_PE, lat: "<2ms", quant: Float8 }
    E5_Causal: { dim: 768, math: SCM_Intervention, lat: "<8ms", quant: "PQ-8", asymmetric: true }
    E6_Sparse: { dim: "~30K 5%", math: TopK, lat: "<3ms", quant: Sparse }
    E7_Code: { dim: 1536, math: AST_Transformer, lat: "<10ms", quant: "PQ-8" }
    E8_Graph: { dim: 384, math: MeanPooling, lat: "<5ms", quant: Float8 }
    E9_HDC: { dim: "10K→1024", math: XOR_Hamming, lat: "<1ms", quant: Binary }
    E10_Multimodal: { dim: 768, math: CrossAttention, lat: "<15ms", quant: "PQ-8" }
    E11_Entity: { dim: 384, math: "h+r≈t", lat: "<2ms", quant: Float8 }
    E12_LateInteraction: { dim: "128D/tok", math: ColBERT_MaxSim, lat: "<8ms", quant: TokenPruning }
    E13_SPLADE: { dim: "~30K sparse", math: SPLADE_v2, lat: "<5ms", quant: Sparse }

  fingerprint:
    semantic_fingerprint: "[E1..E13]"
    purpose_vector: "[A(E1,V)..A(E13,V)]"
    johari_quadrants: "[JQ1..JQ13]"
    purpose_evolution: "TimeSeries<PurposeSnapshot>"

  similarity:
    method: "RRF(d) = Σᵢ 1/(60 + rankᵢ(d))"
    fallback: "S(A,B) = Σᵢ wᵢ · cos(Aᵢ, Bᵢ)"
    query_weights: { semantic: { E1: 0.40, E5: 0.15, E11: 0.15 }, causal: { E5: 0.50, E1: 0.20, E11: 0.15 }, code: { E7: 0.50, E1: 0.20, E8: 0.15 }, temporal: { E2-4: 0.60, E1: 0.20 }, fact: { E11: 0.50, E5: 0.25, E1: 0.15 } }

  # 5-STAGE RETRIEVAL (<60ms @ 1M)
  retrieval:
    S1: { desc: "BM25+E13 sparse", in: "1M+", out: "10K", lat: "<5ms" }
    S2: { desc: "E1[..128] Matryoshka ANN", in: "10K", out: "1K", lat: "<10ms" }
    S3: { desc: "RRF across 13 spaces", in: "1K", out: "100", lat: "<20ms" }
    S4: { desc: "Purpose alignment filter (≥0.55)", in: "100", out: "50", lat: "<10ms" }
    S5: { desc: "E12 MaxSim precision", in: "50", out: "10", lat: "<15ms" }

  causal_asymmetric: { cause_to_effect: 1.2, effect_to_cause: 0.8, same: 1.0 }

# ═══════════════════════════════════════════════════════════════════════
# STORAGE ARCHITECTURE
# ═══════════════════════════════════════════════════════════════════════
storage:
  primary: { dev: rocksdb, prod: scylladb, schema: [id:UUID, embeddings:BYTEA, purpose_vector:REAL[13], johari:BYTEA, north_star_alignment:REAL, dominant_embedder:INT, coherence:REAL, created_at:TIMESTAMPTZ, last_accessed:TIMESTAMPTZ] }
  indexes:
    L2A_sparse: "E13 SPLADE inverted (Stage 1)"
    L2B_matryoshka: "E1[..128] HNSW (Stage 2), M:32, ef:256/128"
    L2C_per_embedder: "13× HNSW quantized (Stage 3), M:16, ef:200/100"
    L2D_purpose: "13D HNSW (Stage 4)"
    L2E_goals: "Tree (Stage 4)"
    L2F_late: "Token HNSW MaxSim (Stage 5)"
  routing: { default: "S1→S2→S3→S4→S5", fast_semantic: "S2→S3(E1)→S5", causal: "S1→S2→S3(E5↑)→S4→S5", code: "S1→S2→S3(E7↑)→S4→S5", purpose: "S2→S4→S5" }
  temporal: { engine: timescaledb, hypertable: purpose_evolution, retention: "90d continuous, then 1/day" }

verbosity: { 0: "~100 tok (raw only)", 1: "~200 tok (text+ids, DEFAULT)", 2: "~800 tok (full insights, ONLY when ΔC<0.4)" }

# ═══════════════════════════════════════════════════════════════════════
# AGENT PROTOCOL
# ═══════════════════════════════════════════════════════════════════════
agent:
  role: "Librarian, not archivist"

  session_start: ["Read .ai/activeContext.md, decisionLog.md, progress.md", "Read constitution.yaml", "Call get_graph_manifest, get_memetic_status", "Call get_consciousness_state", "Call get_system_instructions (~300 tok)"]

  pulse_response: { high_ΔS_high_ΔC: epistemic_action, high_ΔS_low_ΔC: "dream OR critique_context", low_ΔS_high_ΔC: Continue, low_ΔS_low_ΔC: get_neighborhood }

  gwt_checks: { empty_5s: epistemic_action, conflict: critique_context, IC<0.7: warn, IC<0.5: dream, r>0.95: monitor }

  mental_checks:
    "entropy>0.7 for 5min": trigger_dream
    "coherence<0.4": process_curation_tasks
    "empty search": "↑noradrenaline, broaden"
    "irrelevant search": reflect_on_memory
    "conflicting search": "check conflict_alert, merge or ask"
    "MetaScore<0.5 for 5 ops": "↑Acetylcholine, introspective dream"
    "ECE>0.10": trigger_recalibration

  decision_trees:
    store: "Novel (check entropy)? YES+relevant→store with rationale; NO→skip"
    dream: "entropy>0.7 for 5min→full; 30+min work→nrem; entropy<0.5→none"
    curate: "curation_tasks? process FIRST; Dup→merge (check priors!); Conflict→critique then ask; Orphan→forget or link"
    search_fail: "Empty→broaden/generate_search_plan; Irrelevant→reflect_on_memory; Conflicting→resolve or ask"

  session_end: ["Update .ai/activeContext.md, progress.md", "Add decisions to decisionLog.md", "Update specs/tasks/_index.md"]

  steering_feedback:
    infancy: { good: "High ΔS", bad: "Low ΔS" }
    growth: { good: "Balanced ΔS+ΔC", bad: "Imbalanced" }
    maturity: { good: "High ΔC", bad: "Low ΔC" }
    penalties: { missing_rationale: -0.5, near_duplicate: -0.4, low_priors_confidence: -0.3 }

# ═══════════════════════════════════════════════════════════════════════
# META-UTL (Self-Aware Learning)
# ═══════════════════════════════════════════════════════════════════════
meta_utl:
  awareness: [storage_prediction, retrieval_prediction, parameter_optimization]
  learning: { track: "success_rate, prediction_accuracy, parameter_drift", adapt: "λ_ΔS, λ_ΔC by domain/lifecycle" }
  predictors:
    storage_impact: { input: "fingerprint+context", output: "ΔL", accuracy: ">0.85" }
    retrieval_quality: { input: "query+top_k", output: "relevance", accuracy: ">0.80" }
    alignment_drift: { input: "fingerprint+time", output: "future alignment", window: "24h" }
  correction: { threshold: "error>0.2", escalate: "accuracy<0.7 for 100 ops" }

# ═══════════════════════════════════════════════════════════════════════
# NESTED LEARNING (CMS Architecture)
# ═══════════════════════════════════════════════════════════════════════
nested_learning:
  cms_levels:
    L1: { freq: "∞", layer: Reflex, η: 0.1 }
    L2: { freq: "per-query", layer: Memory, η: 0.01 }
    L3: { freq: "per-session", layer: Learning, η: 0.001 }
    L4: { freq: "dream", layer: Coherence, η: 0.0001 }
    L5: { freq: "training", layer: Core, η: 0.00001 }
  hopfield_self_ref: "M = M(αI - ηkkᵀ) + ηv̂kᵀ"
  multi_scale_nt: "w_eff = base × (fast + α×slow) × mod"
  delta_gd: "W_{t+1} = W_t(I - η'xxᵀ) - η'∇L"
  adaptive_cones: "aperture = base × aperture_memory.retrieve(context)"
  nested_utl: "L = tanh(ΔS × ΔC × wₑ × cos_φ)"

# ═══════════════════════════════════════════════════════════════════════
# ΔS/ΔC COMPUTATION
# ═══════════════════════════════════════════════════════════════════════
delta_sc:
  ΔS_methods:
    E1: "GMM+Mahalanobis: ΔS=1-P(e|GMM)"
    E2-4,E8: "KNN: ΔS=σ((d_k-μ)/σ)"
    E5: "Asymmetric KNN: ΔS=d_k×direction_mod"
    E6,E13: "IDF/Jaccard: ΔS=IDF(dims) or 1-jaccard"
    E7: "GMM+KNN: ΔS=0.5×GMM+0.5×KNN"
    E9: "Hamming: ΔS=min_hamming/dim"
    E10: "Cross-modal KNN: ΔS=avg(d_text,d_image)"
    E11: "TransE: ΔS=||h+r-t||"
    E12: "Token KNN: ΔS=max_token(d_k)"

  ΔC: "α×Connectivity + β×ClusterFit + γ×Consistency (0.4, 0.4, 0.2)"
  johari: { Open: "ΔS≤0.5∧ΔC>0.5", Blind: "ΔS>0.5∧ΔC≤0.5", Hidden: "ΔS≤0.5∧ΔC≤0.5", Unknown: "ΔS>0.5∧ΔC>0.5" }
  cross_space_insights: { open_semantic_blind_causal: "Knows WHAT not WHY", blind_semantic_open_code: "Code without context", unknown_all: "Frontier", hidden_all: "Obsolete" }

# ═══════════════════════════════════════════════════════════════════════
# ADAPTIVE THRESHOLD CALIBRATION (ATC)
# ═══════════════════════════════════════════════════════════════════════
adaptive_thresholds:
  rationale: "Different domains/users/drift require different thresholds; per-embedder varies"

  priors: # [prior, range, adapt_speed]
    θ_opt: [0.75, "[0.60,0.90]", session]
    θ_acc: [0.70, "[0.55,0.85]", session]
    θ_warn: [0.55, "[0.40,0.70]", session]
    θ_dup: [0.90, "[0.80,0.98]", hourly]
    θ_edge: [0.70, "[0.50,0.85]", hourly]
    θ_joh: [0.50, "[0.35,0.65]", per-embedder]
    θ_kur: [0.80, "[0.65,0.95]", daily]
    θ_ent_h: [0.70, "[0.55,0.85]", per-query]
    θ_ent_l: [0.40, "[0.25,0.55]", per-query]
    θ_gate: [0.80, "[0.65,0.95]", hourly]

  architecture:
    L1_EWMA: { freq: "per-query", formula: "θ_ewma=α×θ_obs+(1-α)×θ_ewma", drift: "|θ-baseline|/σ", triggers: { ">2": L2, ">3": L3 } }
    L2_Temp: { freq: hourly, formula: "σ(logit(raw)/T)", per_embedder_T: { E1: 1.0, E5: 1.2, E7: 0.9, E9: 1.5, E13: 1.1 }, target: "L_cal<0.05" }
    L3_Bandit: { freq: session, UCB: "argmax[μ(θ)+c×√(ln(N)/n(θ))]", Thompson: "Beta(α,β)→sample→select→update" }
    L4_Bayesian: { freq: weekly, surrogate: "GP(μ,K)", acquisition: "EI(θ)=E[max(0,f(θ)-f(θ_best))]" }

  domain: { Code: "strict", Medical: "very strict, high causal", Legal: "moderate, high semantic", Creative: "loose, exploration", Research: "balanced, novelty", General: "default priors" }

  calibration: { ECE: "<0.05", MCE: "<0.10", Brier: "<0.10" }
  alerts: { "ECE>0.10": L2, "MCE>0.20": investigate, "Brier>0.15": L3, "drift>3.0": L4, "stale>24h": force }
  correction: { minor: "ECE∈[0.05,0.10]→↑EWMA α", moderate: "ECE∈[0.10,0.15]→Thompson+recalibrate", major: "ECE>0.15→reset+Bayesian+human", critical: "ECE>0.25→fallback static+alert" }

# ═══════════════════════════════════════════════════════════════════════
# NORTH AUTONOMOUS SERVICES (NORTH-008 to NORTH-020)
# ═══════════════════════════════════════════════════════════════════════
autonomous_services:
  foundation: # Types only
    NORTH-001: { name: bootstrap, types: [BootstrapConfig, SectionWeights, PendingGoal, ConfirmedGoal] }
    NORTH-002: { name: thresholds, types: [ThresholdConfig, CalibrationLevel, AdaptiveThreshold] }
    NORTH-003: { name: drift, types: [DriftConfig, DriftEvent, AlignmentHistory] }
    NORTH-004: { name: curation, types: [PruningConfig, PruneReason, ConsolidationConfig, ConsolidationCandidate] }
    NORTH-005: { name: evolution, types: [EvolutionConfig, GoalEvolution, SectionEvolution] }
    NORTH-006: { name: workflow, types: [WorkflowConfig, ScheduledTask, EventTrigger] }

  services: # Active logic
    NORTH-008_Bootstrap: { ops: [extract_goals, rank_goals, finalize], triggers: [manual, first_run] }
    NORTH-009_ThresholdLearner: { levels: "L1_EWMA→L2_Temp→L3_Thompson→L4_Bayesian", per_embedder: true, constraint: "θ_opt>θ_acc>θ_warn" }
    NORTH-010_DriftDetector: { methods: [sliding_window, cusum, ewma_crossover], alerts: { mild: ">1.0", moderate: ">2.0", severe: ">3.0", critical: ">4.0 OR <0.55" } }
    NORTH-011_DriftCorrector: { strategies: { mild: weight_adjustment, moderate: "goal_refinement OR memory_reweighting", severe: goal_expansion, critical: full_recalibration }, auto: "≤moderate", escalate: "≥severe" }
    NORTH-012_Pruning: { reasons: [low_alignment_30d, redundant, obsolete, low_access_90d, conflict_resolved], soft_delete: true, recovery: "30 days" }
    NORTH-013_Consolidation: { strategies: [merge, abstract, link, hierarchy], trigger: "dream OR manual OR curation" }
    NORTH-014_GapDetection: { types: [coverage:<3, depth:shallow, temporal:stale_90d, balance:uneven], recommendations: [queries, drill-down, refresh, rebalance] }
    NORTH-015_SubGoalDiscovery: { methods: [HDBSCAN, topic_modeling, frequency, coherence_islands], validation: "coherence>0.7, size>5" }
    NORTH-016_WeightAdjuster: { triggers: [user_feedback, access_patterns, drift_correction, gap_balancing], constraints: "sum=1.0, min=0.05, max_delta=0.10" }
    NORTH-017_ObsolescenceDetector: { signals: [temporal_180d, replacement, contradiction_rate, user_disengagement], actions: [deprecate, archive, merge, retire] }
    NORTH-018_DailyScheduler: { checks: { drift: daily, calibration: hourly, gap: weekly, pruning: weekly, consolidation: dream, health: "6h" }, budget: "GPU<10%, latency<5%", preempt: user_activity }
    NORTH-019_EventOptimizer: { triggers: [memory_spike_10/min, coherence_drop_20%, alignment_shift_10%, pattern_change, resource_90%], actions: [scale_indexes, rebalance_cache, adjust_thresholds, emergency_consolidation] }
    NORTH-020_SelfHealing: { monitors: [embedding_pipeline, index_health, storage_health, coherence_health, threshold_health], severities: [Low, Medium, High, Critical], auto_heal: "≤High", escalate: Critical }

  teleological:
    TELEO-014_FeedbackLearner: { types: [explicit_rating, implicit_signal, correction, rejection], lr: 0.01 }
    TELEO-015_ProfileManager: { dims: [domain_weights, threshold_preferences, interaction_patterns], persistence: cross-session }

# ═══════════════════════════════════════════════════════════════════════
# MEMORY MATH FOUNDATIONS
# ═══════════════════════════════════════════════════════════════════════
memory_math:
  hopfield: { formula: "E = -Σᵢ log(Σⱼ exp(xᵢᵀξⱼ))", capacity: "∝ exp(d)", app: "13 parallel networks + Kuramoto sync" }
  sdm: { address: "2^d possible, ~√(2^d) hard", write: "activate within Hamming r", read: "sum+threshold", noise: ">20% recoverable" }
  kuramoto: { formula: "dθᵢ/dt = ωᵢ + (K/N)Σⱼ sin(θⱼ-θᵢ)", r: "sync measure", thresholds: { coherent: ">0.8", fragment: "<0.5" } }

# ═══════════════════════════════════════════════════════════════════════
# HARDWARE (RTX 5090 + CUDA 13.1)
# ═══════════════════════════════════════════════════════════════════════
hardware:
  gpu: { name: "RTX 5090", arch: "Blackwell GB202", cores: 21760, tensor: 680, sms: 170, vram: "32GB GDDR7", bw: "1792 GB/s", l2: "98MB", compute: "12.0" }
  cuda: { v: "13.1", features: { cuda_tile: "60-80% dev reduction", green_contexts: "SM partitioning", fp4: "70% mem, 3x throughput", grouped_gemm: "4x MoE speedup" } }
  precision: { "E1,E5,E7,E10": "FP8/PQ-8", "E2-4,E8,E11": Float8, E9: Binary, "E6,E13": Sparse, E12: TokenPruning }
  green_contexts: { context_a: { sm: "70%", purpose: "GW+Kuramoto real-time" }, context_b: { sm: "30%", purpose: "Dream+Gardener background" } }
