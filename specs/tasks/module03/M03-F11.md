# M03-F11: EmbeddingConfig Root Configuration

```xml
<task_spec id="M03-F11" version="1.0">
<metadata>
  <title>Define EmbeddingConfig Root Configuration</title>
  <status>ready</status>
  <layer>foundation</layer>
  <sequence>11</sequence>
  <implements>constitution.yaml:embeddings.config, PRD Section 4.3</implements>
  <depends_on>M03-F01</depends_on>
  <estimated_hours>2</estimated_hours>
</metadata>

<context>
Implement the root configuration struct that aggregates all embedding subsystem configuration.
This is the top-level configuration loaded from embeddings.toml that contains:
- Model registry settings (paths, lazy loading, preload list)
- Batch processing settings
- FuseMoE fusion settings
- Cache settings
- GPU settings

The config must be deserializable from TOML and provide sensible defaults.
</context>

<definition_of_done>
  <signatures>
```rust
use std::path::Path;
use serde::{Deserialize, Serialize};
use crate::error::EmbeddingResult;
use crate::config::{ModelRegistryConfig, BatchConfig, FusionConfig, CacheConfig, GpuConfig};

/// Root configuration for the embedding pipeline.
///
/// Aggregates all subsystem configurations.
/// Load from TOML file or use Default::default() for development.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct EmbeddingConfig {
    /// Model registry configuration (paths, lazy loading, etc.)
    pub models: ModelRegistryConfig,

    /// Batch processing configuration
    pub batch: BatchConfig,

    /// FuseMoE fusion layer configuration
    pub fusion: FusionConfig,

    /// Embedding cache configuration
    pub cache: CacheConfig,

    /// GPU configuration
    pub gpu: GpuConfig,
}

impl Default for EmbeddingConfig {
    fn default() -> Self {
        Self {
            models: ModelRegistryConfig::default(),
            batch: BatchConfig::default(),
            fusion: FusionConfig::default(),
            cache: CacheConfig::default(),
            gpu: GpuConfig::default(),
        }
    }
}

impl EmbeddingConfig {
    /// Load configuration from a TOML file.
    ///
    /// # Arguments
    /// * `path` - Path to the TOML configuration file
    ///
    /// # Errors
    /// - EmbeddingError::IoError if file cannot be read
    /// - EmbeddingError::ConfigError if TOML parsing fails
    pub fn from_file(path: impl AsRef<Path>) -> EmbeddingResult<Self>;

    /// Validate all configuration values.
    ///
    /// # Errors
    /// - EmbeddingError::ConfigError with descriptive message if invalid
    pub fn validate(&self) -> EmbeddingResult<()>;

    /// Create configuration with environment variable overrides.
    pub fn with_env_overrides(self) -> Self;
}
```
  </signatures>

  <constraints>
    - All sub-configs must implement Default
    - Serialize/Deserialize with serde for TOML compatibility
    - from_file uses std::fs::read_to_string + toml::from_str
    - validate() checks all nested configs
    - Environment overrides via EMBEDDING_* prefix
    - No panics - return EmbeddingResult for all fallible operations
  </constraints>

  <verification>
    - Default::default() creates valid configuration
    - Serde roundtrip (serialize then deserialize) produces equal config
    - validate() passes for default config
    - from_file returns error for missing file
    - from_file returns error for malformed TOML
  </verification>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/config.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check --package context-graph-embeddings passes</criterion>
  <criterion>cargo test --package context-graph-embeddings passes</criterion>
  <criterion>cargo clippy --package context-graph-embeddings -- -D warnings shows 0 warnings</criterion>
  <criterion>Default config passes validation</criterion>
  <criterion>TOML roundtrip works correctly</criterion>
</validation_criteria>
</task_spec>
```

---

## Implementation Notes

### Dependencies Required in Cargo.toml
```toml
toml = "0.8"
serde = { version = "1.0", features = ["derive"] }
```

### Environment Variable Overrides
```
EMBEDDING_MODELS_DIR - Override models directory path
EMBEDDING_GPU_ENABLED - Enable/disable GPU (true/false)
EMBEDDING_CACHE_MAX_ENTRIES - Override cache size
EMBEDDING_BATCH_MAX_SIZE - Override max batch size
```

### Example TOML Structure
```toml
[models]
models_dir = "./models"
lazy_loading = true
preload_models = ["semantic", "code"]

[batch]
max_batch_size = 32
max_wait_ms = 50

[fusion]
num_experts = 8
top_k = 2
output_dim = 1536

[cache]
enabled = true
max_entries = 100000

[gpu]
enabled = true
device_ids = [0]
```

### Test Cases
1. `test_default_is_valid` - Default passes validate()
2. `test_serde_roundtrip` - Serialize/deserialize equality
3. `test_from_file_missing` - Returns IoError
4. `test_from_file_invalid_toml` - Returns ConfigError
5. `test_env_overrides` - Environment variables applied

---

*Task ID: M03-F11*
*Module: 03 - 12-Model Embedding Pipeline*
*Layer: Foundation*
*Created: 2026-01-01*
