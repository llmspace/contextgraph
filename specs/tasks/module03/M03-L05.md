<?xml version="1.0" encoding="UTF-8"?>
<task_spec id="M03-L05" version="1.0">
<metadata>
  <title>Temporal-Periodic Model (E3 - Fourier Basis)</title>
  <status>ready</status>
  <layer>logic</layer>
  <sequence>5</sequence>
  <implements>PRD: E3 Temporal-Periodic embedding, 512D output, custom computed</implements>
  <depends_on>M03-F09</depends_on>
  <estimated_hours>3</estimated_hours>
</metadata>

<context>
Implement temporal embedding using Fourier basis functions to capture periodic
time patterns. This model produces 512D vectors encoding cyclical time features
like hour-of-day, day-of-week, and month-of-year patterns.

Model specifications:
- Type: Custom computed (no pretrained weights)
- Output dimension: 512D
- Encoding: Sin/cos of time at multiple frequencies
- Periods: hour, day, week, month, year

The temporal-periodic model captures recurring patterns that help identify
content relevance based on time cycles (e.g., work hours vs evenings,
weekdays vs weekends, seasonal patterns).
</context>

<definition_of_done>
  <signatures>
```rust
pub struct TemporalPeriodicModel {
    num_frequencies: usize,
    periods: Vec<Duration>,
    output_dim: usize,
}

/// Standard periods for temporal encoding
pub mod periods {
    pub const HOUR: Duration = Duration::from_secs(3600);
    pub const DAY: Duration = Duration::from_secs(86400);
    pub const WEEK: Duration = Duration::from_secs(604800);
    pub const MONTH: Duration = Duration::from_secs(2592000); // 30 days
    pub const YEAR: Duration = Duration::from_secs(31536000); // 365 days
}

impl TemporalPeriodicModel {
    /// Create new temporal-periodic model with default periods
    pub fn new() -> Self;

    /// Create with custom periods
    pub fn with_periods(periods: Vec<Duration>) -> Self;

    /// Compute Fourier embedding for a timestamp
    fn compute_fourier_embedding(&self, timestamp: DateTime<Utc>) -> Vec<f32>;

    /// Compute sin/cos features for one period
    fn encode_period(&self, timestamp: DateTime<Utc>, period: Duration) -> (f32, f32);

    /// Extract timestamp from input (if available)
    fn extract_timestamp(&self, input: &ModelInput) -> Option<DateTime<Utc>>;
}

#[async_trait]
impl EmbeddingModel for TemporalPeriodicModel {
    fn model_id(&self) -> ModelId { ModelId::TemporalPeriodic }
    fn dimension(&self) -> usize { 512 }
    fn max_tokens(&self) -> usize { 0 } // Not token-based
    fn supported_inputs(&self) -> &[InputType] { &[InputType::Text] }

    fn is_loaded(&self) -> bool { true }
    async fn load(&self) -> EmbeddingResult<()> { Ok(()) }
    async fn unload(&self) -> EmbeddingResult<()> { Ok(()) }

    async fn embed(&self, input: &ModelInput) -> EmbeddingResult<ModelEmbedding>;
    async fn embed_batch(&self, inputs: &[ModelInput]) -> EmbeddingResult<Vec<ModelEmbedding>>;

    fn memory_usage_bytes(&self) -> usize { std::mem::size_of::<Self>() }
    fn warmup_complete(&self) -> bool { true }
}
```
  </signatures>

  <constraints>
    <constraint>Uses sin/cos of time at multiple frequencies</constraint>
    <constraint>Encodes hour-of-day, day-of-week, month-of-year patterns</constraint>
    <constraint>Default periods: hour, day, week, month, year</constraint>
    <constraint>Formula: sin(2*pi*t/period), cos(2*pi*t/period) for each period</constraint>
    <constraint>Multiple frequencies per period for richer representation</constraint>
    <constraint>dimension() returns 512</constraint>
    <constraint>is_custom() returns true via ModelId</constraint>
    <constraint>No pretrained weights, pure computation</constraint>
  </constraints>

  <verification>
    <step>embed() returns 512D vector</step>
    <step>Same time-of-day on different days produces similar hour features</step>
    <step>Same day-of-week on different weeks produces similar day features</step>
    <step>Output values in range [-1, 1] for sin/cos components</step>
    <step>Deterministic output for same timestamp</step>
    <step>Latency under 100 microseconds</step>
  </verification>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/models/custom/temporal_periodic.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check passes</criterion>
  <criterion>cargo test passes</criterion>
  <criterion>Fourier encoding mathematically correct</criterion>
  <criterion>Period boundaries handled correctly</criterion>
</validation_criteria>
</task_spec>
