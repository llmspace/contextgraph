<?xml version="1.0" encoding="UTF-8"?>
<task_spec id="M03-S08" version="1.0">
<metadata>
  <title>Configuration File Loading</title>
  <status>ready</status>
  <layer>surface</layer>
  <sequence>44</sequence>
  <implements>
    - constitution.yaml: embeddings.config
    - PRD: TOML-based configuration for embedding pipeline
    - models_config.toml integration
  </implements>
  <depends_on>
    - M03-F11 (EmbeddingConfig)
    - M03-F12 (ModelRegistryConfig)
    - M03-F13 (BatchConfig)
    - M03-F14 (FusionConfig)
    - M03-F15 (CacheConfig, GpuConfig)
  </depends_on>
  <estimated_hours>2</estimated_hours>
</metadata>

<context>
Implement configuration file loading for the embedding pipeline. Configuration
is sourced from multiple TOML files and can be overridden by environment
variables. The loader must:
- Parse config/embeddings.toml for pipeline settings
- Read models/models_config.toml for model paths
- Merge environment variable overrides
- Validate configuration before returning

This enables deployment flexibility across development, staging, and production
environments without code changes.
</context>

<definition_of_done>
  <signatures>
    <signature name="load_config">
/// Load complete embedding configuration from file.
///
/// # Arguments
/// * `path` - Path to embeddings.toml configuration file
///
/// # Returns
/// Fully validated EmbeddingConfig ready for use
///
/// # Errors
/// - File not found
/// - TOML parse error
/// - Validation failure (e.g., invalid dimension values)
pub fn load_config(path: impl AsRef&lt;Path&gt;) -> EmbeddingResult&lt;EmbeddingConfig&gt;;
    </signature>
    <signature name="load_models_config">
/// Load model path mappings from models_config.toml.
///
/// Returns a map of model identifiers to their file system paths.
/// Validates that critical model directories exist.
pub fn load_models_config(
    path: impl AsRef&lt;Path&gt;,
) -> EmbeddingResult&lt;HashMap&lt;String, ModelPath&gt;&gt;;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ModelPath {
    pub repo: String,
    pub local_path: PathBuf,
    pub revision: Option&lt;String&gt;,
}
    </signature>
    <signature name="merge_with_env">
/// Merge environment variable overrides into configuration.
///
/// Environment variables follow the pattern:
/// CONTEXT_GRAPH_EMBEDDINGS_{SECTION}_{KEY}
///
/// Examples:
/// - CONTEXT_GRAPH_EMBEDDINGS_BATCH_MAX_SIZE=64
/// - CONTEXT_GRAPH_EMBEDDINGS_GPU_ENABLED=false
/// - CONTEXT_GRAPH_EMBEDDINGS_CACHE_MAX_ENTRIES=50000
pub fn merge_with_env(config: &amp;mut EmbeddingConfig);
    </signature>
    <signature name="ConfigLoader">
/// Configuration loader with caching and hot-reload support.
pub struct ConfigLoader {
    config_path: PathBuf,
    models_path: PathBuf,
    cached_config: RwLock&lt;Option&lt;EmbeddingConfig&gt;&gt;,
    last_modified: AtomicU64,
}

impl ConfigLoader {
    pub fn new(config_path: PathBuf, models_path: PathBuf) -> Self;
    pub fn load(&amp;self) -> EmbeddingResult&lt;EmbeddingConfig&gt;;
    pub fn reload(&amp;self) -> EmbeddingResult&lt;EmbeddingConfig&gt;;
    pub fn has_changed(&amp;self) -> bool;
}
    </signature>
  </signatures>

  <constraints>
    <constraint>Config files in TOML format</constraint>
    <constraint>Primary config: config/embeddings.toml</constraint>
    <constraint>Models config: models/models_config.toml</constraint>
    <constraint>Environment variables override file values</constraint>
    <constraint>Validate all config values after loading</constraint>
    <constraint>Return sensible defaults for missing optional values</constraint>
    <constraint>Log warnings for deprecated config keys</constraint>
  </constraints>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/config/loader.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check passes with no errors</criterion>
  <criterion>cargo clippy passes with no warnings</criterion>
  <criterion>load_config successfully parses valid TOML</criterion>
  <criterion>load_config returns error for malformed TOML</criterion>
  <criterion>merge_with_env correctly applies environment overrides</criterion>
  <criterion>load_models_config reads models_config.toml correctly</criterion>
  <criterion>Validation rejects invalid dimension values</criterion>
  <criterion>Missing optional config uses documented defaults</criterion>
</validation_criteria>

<config_schema>
  <example_embeddings_toml>
# config/embeddings.toml

[models]
models_dir = "./models"
lazy_loading = true
preload_models = ["Semantic", "Code"]
auto_download = false
max_concurrent_loads = 2

[batch]
max_batch_size = 32
min_batch_size = 1
max_wait_ms = 50
dynamic_batching = true
padding_strategy = "DynamicMax"
sort_by_length = true

[fusion]
num_experts = 8
top_k = 2
output_dim = 1536
expert_hidden_dim = 4096
load_balance_coef = 0.01
temperature = 1.0

[cache]
enabled = true
max_entries = 100000
max_bytes = 1073741824  # 1GB
ttl_seconds = 3600
eviction_policy = "Lru"

[gpu]
enabled = true
device_ids = [0]
memory_fraction = 0.9
use_cuda_graphs = true
mixed_precision = true
  </example_embeddings_toml>
</config_schema>

<test_cases>
  <test name="test_load_valid_config">
    Load a valid embeddings.toml, verify all fields parsed correctly
  </test>
  <test name="test_load_missing_file">
    Attempt to load non-existent file, expect EmbeddingError::IoError
  </test>
  <test name="test_load_malformed_toml">
    Load file with syntax errors, expect EmbeddingError::ConfigError
  </test>
  <test name="test_env_override">
    Set CONTEXT_GRAPH_EMBEDDINGS_BATCH_MAX_SIZE, verify override applied
  </test>
  <test name="test_models_config_integration">
    Load models_config.toml, verify paths resolve correctly
  </test>
  <test name="test_config_validation">
    Load config with output_dim=0, expect validation failure
  </test>
</test_cases>

<notes>
Use the toml crate for parsing and serde for deserialization.
Consider using config crate for layered configuration with env override support.
</notes>
</task_spec>
