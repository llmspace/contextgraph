# Task Specification: M03-S03

```xml
<task_spec id="M03-S03" version="1.0">
<metadata>
  <title>EmbeddingProvider Bridge</title>
  <status>ready</status>
  <layer>surface</layer>
  <sequence>42</sequence>
  <implements>
    - PRD: Backward compatibility with Module 1 Ghost System
    - PRD: EmbeddingProvider trait implementation
    - Constitution: embeddings.provider.compatibility
  </implements>
  <depends_on>
    - M03-S01 (EmbeddingPipeline Core)
    - M01-xxx (EmbeddingProvider trait from Module 1)
  </depends_on>
  <estimated_hours>2</estimated_hours>
</metadata>

<context>
Implement a bridge that adapts the EmbeddingPipeline to the EmbeddingProvider
trait defined in Module 1 (Ghost System). This enables the 12-model pipeline
to be used anywhere the simpler EmbeddingProvider interface is expected.

The bridge wraps an Arc<EmbeddingPipeline> and implements the EmbeddingProvider
trait, converting FusedEmbedding (with metadata) to simple Vec<f32> vectors
as required by the Module 1 interface.

This allows:
- Backward compatibility with existing code using EmbeddingProvider
- Gradual migration to the full pipeline API
- Use of 12-model embeddings in the Ghost System
</context>

<definition_of_done>
  <signatures>
    <signature>
```rust
/// Bridge adapter from EmbeddingPipeline to EmbeddingProvider trait
pub struct PipelineProvider {
    /// Wrapped embedding pipeline
    pipeline: Arc<EmbeddingPipeline>,
}
```
    </signature>
    <signature>
```rust
impl PipelineProvider {
    /// Create new provider wrapping an existing pipeline
    pub fn new(pipeline: Arc<EmbeddingPipeline>) -> Self;

    /// Create provider and initialize new pipeline with config
    pub async fn from_config(config: EmbeddingConfig) -> EmbeddingResult<Self>;

    /// Get reference to underlying pipeline for advanced usage
    pub fn pipeline(&self) -> &Arc<EmbeddingPipeline>;

    /// Check if the underlying pipeline is initialized
    pub fn is_initialized(&self) -> bool;
}
```
    </signature>
    <signature>
```rust
#[async_trait]
impl EmbeddingProvider for PipelineProvider {
    /// Embed text returning 1536D vector
    async fn embed(&self, text: &str) -> EmbeddingResult<Vec<f32>>;

    /// Batch embed texts returning 1536D vectors
    async fn embed_batch(&self, texts: &[&str]) -> EmbeddingResult<Vec<Vec<f32>>>;

    /// Get embedding dimension (always 1536)
    fn dimension(&self) -> usize;

    /// Get model name for this provider
    fn model_name(&self) -> &str;

    /// Get maximum tokens supported
    fn max_tokens(&self) -> usize;
}
```
    </signature>
    <signature>
```rust
impl Clone for PipelineProvider;
impl Send for PipelineProvider;
impl Sync for PipelineProvider;
```
    </signature>
  </signatures>

  <constraints>
    - Returns 1536D vectors: FusedEmbedding.vector as Vec<f32>
    - Thread-safe: Uses Arc<EmbeddingPipeline> for sharing
    - Compatible: Must implement EmbeddingProvider trait from Module 1
    - Model name: Return "fusemoe-12-pipeline" or configurable name
    - Max tokens: Return minimum across all 12 models (512 default)
    - Error mapping: Map EmbeddingPipeline errors to EmbeddingProvider errors
    - Clone: Must be cheaply cloneable (Arc clone)
    - Initialization: embed() must work after pipeline.initialize()
  </constraints>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/provider.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check passes with no errors</criterion>
  <criterion>cargo clippy passes with no warnings</criterion>
  <criterion>PipelineProvider implements EmbeddingProvider trait</criterion>
  <criterion>PipelineProvider is Send + Sync</criterion>
  <criterion>PipelineProvider is Clone</criterion>
  <criterion>dimension() returns 1536</criterion>
  <criterion>embed() returns Vec<f32> with 1536 elements</criterion>
  <criterion>embed_batch() returns correct number of vectors</criterion>
</validation_criteria>
</task_spec>
```

## Implementation Notes

### Trait Bridge Pattern
```rust
#[async_trait]
impl EmbeddingProvider for PipelineProvider {
    async fn embed(&self, text: &str) -> EmbeddingResult<Vec<f32>> {
        let fused = self.pipeline.embed(text).await?;
        Ok(fused.vector)
    }

    async fn embed_batch(&self, texts: &[&str]) -> EmbeddingResult<Vec<Vec<f32>>> {
        let fused_batch = self.pipeline.embed_batch(texts).await?;
        Ok(fused_batch.into_iter().map(|f| f.vector).collect())
    }

    fn dimension(&self) -> usize {
        1536 // FuseMoE output dimension
    }

    fn model_name(&self) -> &str {
        "fusemoe-12-pipeline"
    }

    fn max_tokens(&self) -> usize {
        512 // Conservative limit
    }
}
```

### Error Mapping
The EmbeddingPipeline uses EmbeddingError, which should be compatible with
or convertible to the error type expected by EmbeddingProvider. If different,
implement From trait for conversion.

### Usage Example
```rust
// Create pipeline and wrap in provider
let config = EmbeddingConfig::default();
let pipeline = Arc::new(EmbeddingPipeline::new(config).await?);
pipeline.initialize().await?;

let provider = PipelineProvider::new(pipeline);

// Use anywhere EmbeddingProvider is expected
let embedding: Vec<f32> = provider.embed("Hello world").await?;
assert_eq!(embedding.len(), 1536);
```

### Module 1 Integration
The EmbeddingProvider trait should be imported from the ghost system module:
```rust
use context_graph_ghost::traits::EmbeddingProvider;
// OR
use context_graph_core::embedding::EmbeddingProvider;
```

---
*Task ID: M03-S03*
*Layer: Surface*
*Module: 03 - 12-Model Embedding Pipeline*
