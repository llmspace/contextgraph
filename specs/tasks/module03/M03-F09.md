# M03-F09: EmbeddingModel Trait

```xml
<task_spec id="M03-F09" version="1.0">
<metadata>
  <title>Define EmbeddingModel Async Trait</title>
  <status>ready</status>
  <layer>foundation</layer>
  <sequence>9</sequence>
  <implements>constitution.yaml:embeddings.models, PRD Section 4.3</implements>
  <depends_on>M03-F01, M03-F03, M03-F06, M03-F08</depends_on>
  <estimated_hours>2</estimated_hours>
</metadata>

<context>
Implement the core EmbeddingModel async trait that all 12 embedding models must implement.
This trait defines the contract for model lifecycle (load/unload), embedding generation,
and resource tracking. It is the foundational abstraction enabling the 12-model pipeline.

The trait must be:
- Thread-safe (Send + Sync) for concurrent embedding generation
- Async for non-blocking model operations
- Extensible for both pretrained (e5, longformer, CLIP) and custom (temporal, HDC) models
</context>

<definition_of_done>
  <signatures>
```rust
use async_trait::async_trait;
use crate::types::{ModelId, ModelInput, ModelEmbedding, InputType};
use crate::error::EmbeddingResult;

#[async_trait]
pub trait EmbeddingModel: Send + Sync {
    /// Returns the unique model identifier.
    fn model_id(&self) -> ModelId;

    /// Returns the output embedding dimension.
    fn dimension(&self) -> usize;

    /// Returns maximum token limit for input.
    fn max_tokens(&self) -> usize;

    /// Returns list of supported input types (Text, Code, Image, Audio).
    fn supported_inputs(&self) -> &[InputType];

    /// Returns true if model weights are loaded in memory.
    fn is_loaded(&self) -> bool;

    /// Load model weights into memory (CPU or GPU).
    async fn load(&self) -> EmbeddingResult<()>;

    /// Unload model weights from memory.
    async fn unload(&self) -> EmbeddingResult<()>;

    /// Generate embedding for a single input.
    async fn embed(&self, input: &ModelInput) -> EmbeddingResult<ModelEmbedding>;

    /// Generate embeddings for a batch of inputs.
    /// Default implementation calls embed() in a loop.
    async fn embed_batch(&self, inputs: &[ModelInput]) -> EmbeddingResult<Vec<ModelEmbedding>> {
        let mut results = Vec::with_capacity(inputs.len());
        for input in inputs {
            results.push(self.embed(input).await?);
        }
        Ok(results)
    }

    /// Returns current memory usage in bytes.
    fn memory_usage_bytes(&self) -> usize;

    /// Returns true if warmup inference has been performed.
    fn warmup_complete(&self) -> bool;
}
```
  </signatures>

  <constraints>
    - Trait must be Send + Sync for thread safety
    - Use async_trait crate for async trait methods
    - embed_batch has default implementation calling embed in loop
    - Document latency constraints in doc comments (embed <10ms target)
    - No blocking operations in async methods
    - Return EmbeddingError::NotInitialized if embed called before load
    - Return EmbeddingError::UnsupportedModality for incompatible input types
  </constraints>

  <verification>
    - Trait compiles with async_trait
    - Can be implemented by mock struct
    - Send + Sync bounds verified by: fn assert_bounds<T: Send + Sync>() {}
    - Default embed_batch implementation works correctly
    - All method signatures match spec exactly
  </verification>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/traits/embedding_model.rs</file>
  <file>crates/context-graph-embeddings/src/traits/mod.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check --package context-graph-embeddings passes</criterion>
  <criterion>cargo test --package context-graph-embeddings passes</criterion>
  <criterion>cargo clippy --package context-graph-embeddings -- -D warnings shows 0 warnings</criterion>
  <criterion>Mock implementation of trait compiles successfully</criterion>
</validation_criteria>
</task_spec>
```

---

## Implementation Notes

### Dependencies Required in Cargo.toml
```toml
async-trait = "0.1"
```

### Module Structure
```
crates/context-graph-embeddings/src/
  traits/
    mod.rs              # pub mod embedding_model; pub use embedding_model::*;
    embedding_model.rs  # This file
```

### Test Cases
1. `test_trait_is_send_sync` - Verify bounds
2. `test_default_embed_batch` - Verify default implementation
3. `test_mock_implementation` - Verify trait can be implemented

### Latency Targets (Document in rustdoc)
- embed(): <10ms for most models
- embed_batch(): <100ms for batch of 32
- load(): <30s for large models
- unload(): <1s

---

*Task ID: M03-F09*
*Module: 03 - 12-Model Embedding Pipeline*
*Layer: Foundation*
*Created: 2026-01-01*
