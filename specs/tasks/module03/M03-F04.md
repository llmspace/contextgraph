# Task Specification: M03-F04

```xml
<task_spec id="M03-F04" version="1.0">
<metadata>
  <title>Define ConcatenatedEmbedding for All 12 Model Outputs</title>
  <status>ready</status>
  <layer>foundation</layer>
  <sequence>4</sequence>
  <implements>constitution.yaml: embeddings.concatenation</implements>
  <depends_on>M03-F01, M03-F03</depends_on>
  <estimated_hours>1.5</estimated_hours>
</metadata>

<context>
Implement ConcatenatedEmbedding struct that holds outputs from all 12 models.
This struct aggregates individual model embeddings and provides methods to
concatenate them into a single vector for FuseMoE input.

The struct must track:
- Which models have produced embeddings
- The concatenated result vector
- Total processing latency across all models
- Content hash for caching purposes
</context>

<definition_of_done>
  <signatures>
```rust
#[derive(Debug, Clone)]
pub struct ConcatenatedEmbedding {
    pub embeddings: [Option<ModelEmbedding>; 12],
    pub concatenated: Vec<f32>,
    pub total_latency_us: u64,
    pub content_hash: u64,
}

impl ConcatenatedEmbedding {
    pub fn new() -> Self;
    pub fn set(&mut self, embedding: ModelEmbedding);
    pub fn get(&self, model_id: ModelId) -> Option<&ModelEmbedding>;
    pub fn is_complete(&self) -> bool;
    pub fn missing_models(&self) -> Vec<ModelId>;
    pub fn concatenate(&mut self);
    pub fn total_dimension(&self) -> usize;
}
```
  </signatures>

  <constraints>
    <constraint>embeddings array indexed by ModelId as u8</constraint>
    <constraint>is_complete() requires all 12 models present</constraint>
    <constraint>concatenate() builds final vector in model order (0-11)</constraint>
    <constraint>total_latency_us sums all individual model latencies</constraint>
    <constraint>content_hash must be consistent for same content</constraint>
  </constraints>

  <verification>
    <check>new() creates struct with all None embeddings</check>
    <check>set() places embedding at correct index based on model_id</check>
    <check>get() retrieves correct embedding by model_id</check>
    <check>is_complete() returns true only when all 12 present</check>
    <check>missing_models() returns empty vec when complete</check>
    <check>concatenate() produces vector of TOTAL_CONCATENATED length</check>
    <check>Model order in concatenation matches enum order</check>
  </verification>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/types/embedding.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check passes</criterion>
  <criterion>cargo test passes</criterion>
  <criterion>Unit tests for complete and incomplete states</criterion>
  <criterion>Concatenation order matches ModelId enum order</criterion>
</validation_criteria>

<concatenation_order>
The concatenated vector is built in this exact order:
1. Semantic (1024 floats)
2. TemporalRecent (512 floats)
3. TemporalPeriodic (512 floats)
4. TemporalPositional (512 floats)
5. Causal (768 floats)
6. Sparse (1536 floats, projected)
7. Code (768 floats)
8. Graph (384 floats)
9. HDC (1024 floats, projected)
10. Multimodal (768 floats)
11. Entity (384 floats)
12. LateInteraction (128 floats, pooled)

Total: 8320 floats
</concatenation_order>
</task_spec>
```
