# Task Specification: M03-F05

```xml
<task_spec id="M03-F05" version="1.0">
<metadata>
  <title>Define FusedEmbedding Struct (1536D Output)</title>
  <status>ready</status>
  <layer>foundation</layer>
  <sequence>5</sequence>
  <implements>constitution.yaml: embeddings.fused_output</implements>
  <depends_on>M03-F01, M03-F02</depends_on>
  <estimated_hours>2</estimated_hours>
</metadata>

<context>
Implement FusedEmbedding struct - the final 1536D output from FuseMoE fusion.
This is the primary embedding representation used throughout the system for
similarity search, clustering, and downstream tasks.

The struct must capture:
- The 1536D fused vector
- Expert routing information (which experts were selected)
- Expert weights (contribution of each expert)
- Pipeline timing for performance monitoring
- Content hash for caching
</context>

<definition_of_done>
  <signatures>
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct FusedEmbedding {
    pub vector: Vec<f32>,
    pub expert_weights: [f32; 8],
    pub selected_experts: [u8; 2],
    pub pipeline_latency_us: u64,
    pub content_hash: u64,
}

impl FusedEmbedding {
    pub const DIMENSION: usize = 1536;
    pub const NUM_EXPERTS: usize = 8;
    pub const TOP_K: usize = 2;

    pub fn new(vector: Vec<f32>, expert_weights: [f32; 8], selected: [u8; 2]) -> EmbeddingResult<Self>;
    pub fn validate(&self) -> EmbeddingResult<()>;
    pub fn normalize(&mut self);
    pub fn cosine_similarity(&self, other: &FusedEmbedding) -> f32;
    pub fn to_bytes(&self) -> Vec<u8>;
    pub fn from_bytes(bytes: &[u8]) -> EmbeddingResult<Self>;
}
```
  </signatures>

  <constraints>
    <constraint>vector.len() must equal DIMENSION (1536)</constraint>
    <constraint>validate() rejects NaN/Inf values in vector</constraint>
    <constraint>expert_weights sum must be approximately 1.0 (within 0.01)</constraint>
    <constraint>selected_experts values must be less than NUM_EXPERTS (0-7)</constraint>
    <constraint>Serde serialization must be compact and efficient</constraint>
  </constraints>

  <verification>
    <check>new() validates dimension is exactly 1536</check>
    <check>new() validates expert indices are valid (0-7)</check>
    <check>validate() catches NaN values</check>
    <check>validate() catches Inf values</check>
    <check>validate() verifies expert_weights sum to ~1.0</check>
    <check>normalize() produces unit vector</check>
    <check>cosine_similarity() returns 1.0 for identical vectors</check>
    <check>cosine_similarity() returns 0.0 for orthogonal vectors</check>
    <check>to_bytes() and from_bytes() round-trip correctly</check>
    <check>Serde JSON round-trip works correctly</check>
  </verification>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/types/fused.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check passes</criterion>
  <criterion>cargo test passes</criterion>
  <criterion>Serde derive compiles without issues</criterion>
  <criterion>Binary serialization is compact (approx 6KB per embedding)</criterion>
</validation_criteria>

<binary_format>
Byte layout for to_bytes()/from_bytes():
- Bytes 0-6143: vector (1536 * 4 bytes as f32)
- Bytes 6144-6175: expert_weights (8 * 4 bytes as f32)
- Bytes 6176-6177: selected_experts (2 * 1 byte as u8)
- Bytes 6178-6185: pipeline_latency_us (8 bytes as u64)
- Bytes 6186-6193: content_hash (8 bytes as u64)

Total: 6194 bytes per embedding
</binary_format>
</task_spec>
```
