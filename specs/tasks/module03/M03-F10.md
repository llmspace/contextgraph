# M03-F10: ModelFactory Trait

```xml
<task_spec id="M03-F10" version="1.0">
<metadata>
  <title>Define ModelFactory Trait for Model Creation</title>
  <status>ready</status>
  <layer>foundation</layer>
  <sequence>10</sequence>
  <implements>constitution.yaml:embeddings.factory, PRD Section 4.3</implements>
  <depends_on>M03-F01, M03-F09</depends_on>
  <estimated_hours>1</estimated_hours>
</metadata>

<context>
Define the ModelFactory trait for creating embedding model instances with configuration.
This trait enables dependency injection and testability by abstracting model creation.
The factory is responsible for:
- Creating the correct model type based on ModelId
- Applying device placement (CPU/GPU) configuration
- Applying quantization settings
- Estimating memory requirements before allocation
</context>

<definition_of_done>
  <signatures>
```rust
use crate::types::ModelId;
use crate::traits::EmbeddingModel;
use crate::config::SingleModelConfig;
use crate::error::EmbeddingResult;

/// Factory for creating embedding model instances.
pub trait ModelFactory: Send + Sync {
    /// Create a model instance for the given ModelId with configuration.
    ///
    /// # Arguments
    /// * `model_id` - The model variant to create
    /// * `config` - Model-specific configuration (device, quantization, etc.)
    ///
    /// # Returns
    /// A boxed EmbeddingModel trait object
    ///
    /// # Errors
    /// - EmbeddingError::ModelNotFound if model_id not supported
    /// - EmbeddingError::ConfigError if configuration invalid
    fn create_model(
        &self,
        model_id: ModelId,
        config: &SingleModelConfig,
    ) -> EmbeddingResult<Box<dyn EmbeddingModel>>;

    /// Returns list of ModelIds this factory can create.
    fn supported_models(&self) -> &[ModelId];

    /// Estimate memory usage for loading a model.
    ///
    /// # Arguments
    /// * `model_id` - The model to estimate
    ///
    /// # Returns
    /// Estimated bytes required (0 if unknown)
    fn estimate_memory(&self, model_id: ModelId) -> usize;
}
```
  </signatures>

  <constraints>
    - Trait must be Send + Sync for thread-safe factory access
    - create_model returns Box<dyn EmbeddingModel> for type erasure
    - supported_models returns static slice reference for efficiency
    - estimate_memory should return conservative overestimates
    - Factory does NOT load models - just creates unloaded instances
  </constraints>

  <verification>
    - Trait compiles successfully
    - Can be implemented by mock factory
    - create_model signature accepts SingleModelConfig
    - estimate_memory returns appropriate values per model
    - All 12 ModelId variants have memory estimates
  </verification>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/traits/model_factory.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check --package context-graph-embeddings passes</criterion>
  <criterion>cargo test --package context-graph-embeddings passes</criterion>
  <criterion>cargo clippy --package context-graph-embeddings -- -D warnings shows 0 warnings</criterion>
  <criterion>Mock factory implementation compiles</criterion>
</validation_criteria>
</task_spec>
```

---

## Implementation Notes

### Memory Estimates by Model (Reference)
| ModelId | Estimated Memory (bytes) |
|---------|-------------------------|
| Semantic (e5-large) | 1.3 GB |
| TemporalRecent | 10 MB |
| TemporalPeriodic | 10 MB |
| TemporalPositional | 10 MB |
| Causal (longformer) | 600 MB |
| Sparse (SPLADE) | 500 MB |
| Code (CodeBERT) | 500 MB |
| Graph (MiniLM) | 100 MB |
| Hdc | 50 MB |
| Multimodal (CLIP) | 1.5 GB |
| Entity (MiniLM) | 100 MB |
| LateInteraction (ColBERT) | 400 MB |

### Module Export
Add to `crates/context-graph-embeddings/src/traits/mod.rs`:
```rust
pub mod model_factory;
pub use model_factory::ModelFactory;
```

### Test Cases
1. `test_trait_is_send_sync` - Verify bounds
2. `test_supported_models_contains_all` - All 12 variants
3. `test_estimate_memory_nonzero` - All estimates > 0

---

*Task ID: M03-F10*
*Module: 03 - 12-Model Embedding Pipeline*
*Layer: Foundation*
*Created: 2026-01-01*
