# Task Specification: M03-F03

```xml
<task_spec id="M03-F03" version="1.0">
<metadata>
  <title>Define ModelEmbedding Struct for Single Model Output</title>
  <status>ready</status>
  <layer>foundation</layer>
  <sequence>3</sequence>
  <implements>constitution.yaml: embeddings.output_format</implements>
  <depends_on>M03-F01</depends_on>
  <estimated_hours>1.5</estimated_hours>
</metadata>

<context>
Implement ModelEmbedding struct representing output from a single embedding model.
This struct captures the embedding vector along with metadata about which model
produced it and timing information for performance monitoring.

The struct must support:
- Validation of dimension against expected model output
- Detection of invalid values (NaN, Inf)
- L2 normalization to unit vectors
- Optional attention weights for interpretability
</context>

<definition_of_done>
  <signatures>
```rust
#[derive(Debug, Clone)]
pub struct ModelEmbedding {
    pub model_id: ModelId,
    pub vector: Vec<f32>,
    pub latency_us: u64,
    pub attention_weights: Option<Vec<f32>>,
}

impl ModelEmbedding {
    pub fn new(model_id: ModelId, vector: Vec<f32>, latency_us: u64) -> Self;
    pub fn dimension(&self) -> usize;
    pub fn validate(&self) -> EmbeddingResult<()>;
    pub fn normalize(&mut self);
    pub fn l2_norm(&self) -> f32;
}
```
  </signatures>

  <constraints>
    <constraint>validate() checks dimension matches model_id.dimension()</constraint>
    <constraint>validate() checks no NaN or Inf values in vector</constraint>
    <constraint>normalize() produces unit vector (L2 norm = 1.0)</constraint>
    <constraint>Attention weights length must match input token count when present</constraint>
  </constraints>

  <verification>
    <check>ModelEmbedding::new() creates valid struct</check>
    <check>dimension() returns vector.len()</check>
    <check>validate() returns error for wrong dimension</check>
    <check>validate() returns error for NaN values</check>
    <check>validate() returns error for Inf values</check>
    <check>normalize() produces L2 norm of 1.0 (within epsilon)</check>
    <check>l2_norm() returns correct Euclidean norm</check>
  </verification>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/src/types/embedding.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo check passes</criterion>
  <criterion>cargo test passes</criterion>
  <criterion>Unit tests for all methods</criterion>
  <criterion>Edge case tests for zero vectors, single element, large vectors</criterion>
</validation_criteria>

<implementation_notes>
- Use f32::is_nan() and f32::is_infinite() for validation
- L2 norm calculation: sqrt(sum of squares)
- Normalization: divide each element by L2 norm
- Handle zero vector case in normalization (avoid division by zero)
</implementation_notes>
</task_spec>
```
