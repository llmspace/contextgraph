<?xml version="1.0" encoding="UTF-8"?>
<task_spec id="M03-S09" version="1.0">
<metadata>
  <title>Unit Tests Suite</title>
  <status>ready</status>
  <layer>surface</layer>
  <sequence>45</sequence>
  <implements>
    - PRD: Test coverage requirements (&gt;90% for Foundation types)
    - Quality gate: Foundation Complete verification
  </implements>
  <depends_on>
    - M03-F01 through M03-F16 (All Foundation layer tasks)
  </depends_on>
  <estimated_hours>4</estimated_hours>
</metadata>

<context>
Create comprehensive unit tests for all Foundation layer types. These tests
ensure correctness of the core type definitions, validations, and behaviors
before integration with the Logic and Surface layers. Tests should be fast,
isolated, and not require external resources (models, GPU, network).
</context>

<definition_of_done>
  <signatures>
    <signature name="test_module_structure">
// crates/context-graph-embeddings/tests/unit/mod.rs
mod model_id_tests;
mod embedding_tests;
mod fused_tests;
mod input_tests;
mod error_tests;
mod config_tests;
mod trait_tests;
    </signature>
    <signature name="model_id_tests">
// crates/context-graph-embeddings/tests/unit/model_id_tests.rs
#[test] fn test_model_id_all_returns_12_variants();
#[test] fn test_model_id_dimensions();
#[test] fn test_model_id_is_custom();
#[test] fn test_model_id_is_pretrained();
#[test] fn test_model_id_model_repo();
#[test] fn test_model_id_model_path();
#[test] fn test_model_id_max_tokens();
#[test] fn test_model_id_serde_roundtrip();
#[test] fn test_dimensions_total_correct();
    </signature>
    <signature name="embedding_tests">
// crates/context-graph-embeddings/tests/unit/embedding_tests.rs
#[test] fn test_model_embedding_new();
#[test] fn test_model_embedding_validate_dimension();
#[test] fn test_model_embedding_validate_nan();
#[test] fn test_model_embedding_validate_inf();
#[test] fn test_model_embedding_normalize();
#[test] fn test_model_embedding_l2_norm();
#[test] fn test_concatenated_embedding_new();
#[test] fn test_concatenated_embedding_set_get();
#[test] fn test_concatenated_embedding_is_complete();
#[test] fn test_concatenated_embedding_missing_models();
#[test] fn test_concatenated_embedding_concatenate_order();
    </signature>
    <signature name="fused_tests">
// crates/context-graph-embeddings/tests/unit/fused_tests.rs
#[test] fn test_fused_embedding_new_valid();
#[test] fn test_fused_embedding_new_wrong_dimension();
#[test] fn test_fused_embedding_validate();
#[test] fn test_fused_embedding_normalize();
#[test] fn test_fused_embedding_cosine_similarity();
#[test] fn test_fused_embedding_to_from_bytes();
#[test] fn test_fused_embedding_expert_weights_sum();
    </signature>
    <signature name="input_tests">
// crates/context-graph-embeddings/tests/unit/input_tests.rs
#[test] fn test_model_input_text();
#[test] fn test_model_input_code();
#[test] fn test_model_input_content_hash_deterministic();
#[test] fn test_model_input_byte_size();
#[test] fn test_input_type_from_model_input();
#[test] fn test_image_format_variants();
    </signature>
    <signature name="error_tests">
// crates/context-graph-embeddings/tests/unit/error_tests.rs
#[test] fn test_error_display_messages();
#[test] fn test_error_from_io();
#[test] fn test_error_variants_complete();
    </signature>
    <signature name="config_tests">
// crates/context-graph-embeddings/tests/unit/config_tests.rs
#[test] fn test_embedding_config_default();
#[test] fn test_model_registry_config_default();
#[test] fn test_batch_config_default();
#[test] fn test_fusion_config_default();
#[test] fn test_cache_config_default();
#[test] fn test_gpu_config_default();
#[test] fn test_config_validate_valid();
#[test] fn test_config_validate_invalid_dimensions();
#[test] fn test_device_placement_variants();
#[test] fn test_quantization_mode_variants();
#[test] fn test_padding_strategy_variants();
#[test] fn test_eviction_policy_variants();
    </signature>
  </signatures>

  <constraints>
    <constraint>All tests must pass with `cargo test`</constraint>
    <constraint>No external dependencies (models, GPU, network)</constraint>
    <constraint>Tests complete in under 10 seconds total</constraint>
    <constraint>Use proptest for property-based testing where appropriate</constraint>
    <constraint>Cover all public methods and enum variants</constraint>
    <constraint>Test edge cases: empty inputs, max values, boundary conditions</constraint>
    <constraint>Achieve &gt;90% code coverage on types module</constraint>
  </constraints>
</definition_of_done>

<files_to_create>
  <file>crates/context-graph-embeddings/tests/unit/mod.rs</file>
  <file>crates/context-graph-embeddings/tests/unit/model_id_tests.rs</file>
  <file>crates/context-graph-embeddings/tests/unit/embedding_tests.rs</file>
  <file>crates/context-graph-embeddings/tests/unit/fused_tests.rs</file>
  <file>crates/context-graph-embeddings/tests/unit/input_tests.rs</file>
  <file>crates/context-graph-embeddings/tests/unit/error_tests.rs</file>
  <file>crates/context-graph-embeddings/tests/unit/config_tests.rs</file>
</files_to_create>

<validation_criteria>
  <criterion>cargo test --package context-graph-embeddings passes</criterion>
  <criterion>All 50+ unit tests pass</criterion>
  <criterion>cargo tarpaulin shows &gt;90% coverage on types module</criterion>
  <criterion>No flaky tests (run 10x without failure)</criterion>
  <criterion>Tests complete in under 10 seconds</criterion>
</validation_criteria>

<test_categories>
  <category name="ModelId">
    <test>all() returns exactly 12 variants</test>
    <test>Semantic.dimension() == 1024</test>
    <test>TemporalRecent.is_custom() == true</test>
    <test>Semantic.model_repo() == Some("intfloat/e5-large-v2")</test>
    <test>Serde JSON roundtrip preserves value</test>
  </category>
  <category name="ModelEmbedding">
    <test>validate() passes for correct dimension</test>
    <test>validate() fails for wrong dimension</test>
    <test>validate() fails for NaN values</test>
    <test>normalize() produces unit vector (L2=1.0)</test>
  </category>
  <category name="FusedEmbedding">
    <test>new() rejects wrong dimension (not 1536)</test>
    <test>expert_weights sum approximately 1.0</test>
    <test>cosine_similarity(self, self) == 1.0</test>
    <test>to_bytes/from_bytes roundtrip</test>
  </category>
  <category name="Configuration">
    <test>Default values are sensible</test>
    <test>Validation catches invalid values</test>
    <test>All enum variants are tested</test>
  </category>
</test_categories>

<notes>
Consider using test fixtures for common embedding vectors.
Use const for expected dimension values to keep tests in sync with implementation.
Add #[should_panic] tests for validation failures where appropriate.
</notes>
</task_spec>
