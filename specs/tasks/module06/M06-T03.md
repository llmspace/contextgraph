# M06-T03: Define PersistentMemoryStore Interface

```yaml
metadata:
  id: "M06-T03"
  title: "Define PersistentMemoryStore Interface"
  module: "module-06"
  module_name: "Stub Elimination"
  layer: "foundation"
  priority: "critical"
  estimated_hours: 3
  created: "2026-01-04"
  updated: "2026-01-04"
  status: "complete"
  verified_by: "sherlock-holmes"
  verification_date: "2026-01-04"
  dependencies: []
  spec_refs:
    - "constitution.yaml:30"         # db: { dev: sqlite, prod: postgres16+, vector: faiss_gpu }
    - "constitution.yaml:187-194"    # 5-Layer Bio-Nervous System
    - "contextprd.md:211-217"        # KnowledgeNode/GraphEdge schema
```

## STATUS: COMPLETE âœ“

**Verified by sherlock-holmes on 2026-01-04**

All requirements have been implemented and verified:
- 6 new trait methods added to `MemoryStore`
- `StorageBackend` enum and `StorageConfig` struct defined
- `InMemoryStore` implements all methods
- 20/20 tests passing

---

## Summary of What Was Implemented

### Files Modified

| File | Changes |
|------|---------|
| `crates/context-graph-core/src/traits/memory_store.rs` | Added `StorageBackend` enum, `StorageConfig` struct, and 6 new trait methods |
| `crates/context-graph-core/src/stubs/memory_stub.rs` | Implemented all new methods in `InMemoryStore` |
| `crates/context-graph-core/src/traits/mod.rs` | Exported `StorageBackend` and `StorageConfig` |

### New Trait Methods (Lines 213-278)

| Method | Signature | Purpose |
|--------|-----------|---------|
| `flush` | `async fn flush(&self) -> CoreResult<()>` | Flush buffered writes to storage |
| `checkpoint` | `async fn checkpoint(&self) -> CoreResult<PathBuf>` | Create recovery snapshot |
| `restore` | `async fn restore(&self, checkpoint: &Path) -> CoreResult<()>` | Restore from checkpoint |
| `node_count_sync` | `fn node_count_sync(&self) -> usize` | Sync node count for hot paths |
| `storage_size_bytes` | `fn storage_size_bytes(&self) -> usize` | Storage size estimation |
| `backend_type` | `fn backend_type(&self) -> StorageBackend` | Identify backend type |

### StorageBackend Enum (Lines 17-31)

```rust
pub enum StorageBackend {
    InMemory,   // Development/testing only
    SQLite,     // Development file-based
    RocksDB,    // Production embedded
    PostgreSQL, // Production distributed
}
```

### StorageConfig Struct (Lines 51-117)

```rust
pub struct StorageConfig {
    pub backend: StorageBackend,
    pub path: Option<PathBuf>,
    pub cache_size_mb: usize,
    pub sync_writes: bool,
}
```

With factory methods: `StorageConfig::rocksdb()`, `StorageConfig::sqlite()`, `StorageConfig::postgresql()`

---

## Verification Evidence

### Test Results

```
cargo test -p context-graph-core memory_stub -- --nocapture

running 20 tests
test stubs::memory_stub::tests::test_backend_type ... ok
test stubs::memory_stub::tests::test_checkpoint_restore ... ok
test stubs::memory_stub::tests::test_checkpoint_restore_empty_store ... ok
test stubs::memory_stub::tests::test_checkpoint_with_empty_content ... ok
test stubs::memory_stub::tests::test_cosine_similarity ... ok
test stubs::memory_stub::tests::test_flush_is_noop ... ok
test stubs::memory_stub::tests::test_hard_delete ... ok
test stubs::memory_stub::tests::test_memory_multiple_nodes_independent ... ok
test stubs::memory_stub::tests::test_memory_round_trip_embedding_integrity ... ok
test stubs::memory_stub::tests::test_memory_round_trip_exact_match ... ok
test stubs::memory_stub::tests::test_memory_round_trip_metadata_integrity ... ok
test stubs::memory_stub::tests::test_memory_search_returns_correct_nodes ... ok
test stubs::memory_stub::tests::test_memory_update_preserves_unmodified_fields ... ok
test stubs::memory_stub::tests::test_node_count_sync ... ok
test stubs::memory_stub::tests::test_restore_invalid_path ... ok
test stubs::memory_stub::tests::test_search ... ok
test stubs::memory_stub::tests::test_soft_delete ... ok
test stubs::memory_stub::tests::test_storage_size_bytes ... ok
test stubs::memory_stub::tests::test_store_and_retrieve ... ok
test stubs::memory_stub::tests::test_retrieve_not_found ... ok

test result: ok. 20 passed; 0 failed; 0 ignored
```

### Commit History

```
457ed34 fix(stubs): ensure checkpoint file uniqueness in parallel tests
03a758d feat(core): extend MemoryStore trait with StorageBackend abstraction (M06-T03 prep)
```

---

## Implementation Details for Reference

### InMemoryStore Checkpoint Implementation

Creates unique checkpoint files using timestamp + UUID to prevent conflicts in parallel tests:

```rust
let path = std::env::temp_dir().join(format!(
    "inmemory_checkpoint_{}_{}.json",
    chrono::Utc::now().timestamp_millis(),
    uuid::Uuid::new_v4()
));
```

### Known Limitations (Documented, Not Bugs)

1. **`search_text()` returns 0.5 similarity** - This is intentional for the stub because computing real embeddings requires `EmbeddingProvider` integration (M06-T04).

2. **`node_count_sync()` uses `try_read()`** - May return 0 if lock is held; acceptable for sync hot path.

3. **InMemoryStore is development-only** - Real persistence requires M06-T05 (RocksDB implementation).

---

## Related Tasks

| Task | Relationship |
|------|--------------|
| M06-T05 | Implements RocksDB backend using this trait |
| M06-T10 | Wires production storage into MCP server |
| M06-T04 | Provides embeddings for `search_text()` |

---

*Task completed: 2026-01-04*
*Module: 06 - Stub Elimination*
*Layer: Foundation*
*Priority: CRITICAL*
*Status: COMPLETE*
