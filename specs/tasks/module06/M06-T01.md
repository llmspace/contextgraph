# M06-T01: Bridge UtlProcessor Trait to Real Implementation

```yaml
metadata:
  id: "M06-T01"
  title: "Bridge UtlProcessor Trait to Real Implementation"
  module: "module-06"
  module_name: "Stub Elimination"
  layer: "foundation"
  priority: "critical"
  created: "2026-01-04"
  updated: "2026-01-04"
  status: "complete"
  dependencies: []
  spec_refs:
    - "constitution.yaml:151-167"  # UTL formula: L = f((ΔS × ΔC) · wₑ · cos φ)
    - "learntheory.md"             # Full UTL theoretical foundation
```

## Status: COMPLETE

**VERIFIED 2026-01-04**: Implementation is at `crates/context-graph-mcp/src/adapters/utl_adapter.rs` (579 lines, 11 passing tests).

## Problem Statement

The real `UtlProcessor` exists in `context-graph-utl` crate but the MCP server uses `StubUtlProcessor` which returns hash-based fake values. The adapter bridges the real implementation to the core trait interface.

## Architecture Decision

**CRITICAL**: The adapter lives in `context-graph-mcp` crate (NOT `context-graph-core`) to avoid cyclic dependencies:
- `context-graph-utl` depends on `context-graph-core` for types
- The adapter bridges both, requiring a crate that depends on both
- `context-graph-mcp` depends on both, making it the correct location

## Current Implementation (VERIFIED)

### File: `crates/context-graph-mcp/src/adapters/utl_adapter.rs`

```rust
pub struct UtlProcessorAdapter {
    inner: Arc<RwLock<RealUtlProcessor>>,  // std::sync::RwLock
    metrics: Arc<RwLock<UtlComputationMetrics>>,
}

#[async_trait]
impl UtlProcessor for UtlProcessorAdapter {
    // All 8 trait methods implemented
    // Uses tokio::task::spawn_blocking for async-sync bridging
}
```

### Implemented Methods (8 total)

| Method | Line | Bridge Pattern |
|--------|------|----------------|
| `compute_learning_score` | 139 | `spawn_blocking` + write lock |
| `compute_surprise` | 179 | `spawn_blocking` + write lock |
| `compute_coherence_change` | 201 | `spawn_blocking` + write lock |
| `compute_emotional_weight` | 223 | `spawn_blocking` + write lock |
| `compute_alignment` | 245 | `spawn_blocking` + write lock |
| `should_consolidate` | 266 | `spawn_blocking` + read lock |
| `compute_metrics` | 283 | `spawn_blocking` + write lock |
| `get_status` | 318 | Sync - blocking_read |

### Dependency Configuration

**File: `crates/context-graph-mcp/Cargo.toml`**
```toml
[dependencies]
context-graph-utl = { path = "../context-graph-utl" }
# Direct dependency, no feature flag needed
```

**File: `crates/context-graph-mcp/src/lib.rs`**
```rust
pub mod adapters;
pub use adapters::UtlProcessorAdapter;
```

## UTL Formula Reference (constitution.yaml:152)

```
L = f((ΔS × ΔC) · wₑ · cos φ)
```
- ΔS: entropy/novelty [0,1]
- ΔC: coherence/understanding [0,1]
- wₑ: emotional weight [0.5,1.5]
- φ: phase sync [0,π]

## Marblestone Lifecycle Stages (constitution.yaml:165-167)

| Stage | Interactions | λ_ΔS | λ_ΔC | Focus |
|-------|--------------|------|------|-------|
| Infancy | 0-50 | 0.7 | 0.3 | capture-novelty |
| Growth | 50-500 | 0.5 | 0.5 | balanced |
| Maturity | 500+ | 0.3 | 0.7 | curation-coherence |

## Tests (11 passing)

```bash
cargo test -p context-graph-mcp adapters -- --nocapture
```

| Test | Purpose |
|------|---------|
| `test_adapter_creation` | Verify adapter initializes with Infancy stage |
| `test_adapter_computes_real_learning_score` | Verify real computation returns [0,1] |
| `test_adapter_get_status_returns_live_values` | Verify get_status shows computation count > 0 |
| `test_adapter_lifecycle_progression` | Verify Infancy→Growth at 50 interactions |
| `test_adapter_error_propagation` | Verify errors propagate, no silent failures |
| `test_adapter_compute_metrics` | Verify all UTL components in valid ranges |
| `test_adapter_should_consolidate` | Verify consolidation threshold logic |
| `test_adapter_deterministic_outputs` | Verify consistent valid outputs |
| `test_adapter_status_thresholds_schema` | Verify JSON schema completeness |
| `test_edge_case_empty_input` | Verify empty input doesn't panic |
| `test_clone_shares_state` | Verify Arc-based state sharing |

## Expected get_status() JSON Schema

```json
{
  "lifecycle_phase": "Growth",
  "interaction_count": 150,
  "entropy": 0.45,
  "coherence": 0.55,
  "learning_score": 0.65,
  "johari_quadrant": "Open",
  "consolidation_phase": "Wake",
  "phase_angle": 1.57,
  "lambda_weights": {
    "lambda_s": 0.5,
    "lambda_c": 0.5
  },
  "thresholds": {
    "entropy_trigger": 0.7,
    "coherence_trigger": 0.5,
    "min_importance_store": 0.3,
    "consolidation_threshold": 0.5
  }
}
```

## What Remains (Out of Scope - M06-T10)

The adapter is NOT YET WIRED into the MCP server. Current server.rs:

```rust
// server.rs:34 - STILL USING STUB
let utl_processor: Arc<dyn UtlProcessor> = Arc::new(StubUtlProcessor::new());
```

Task M06-T10 will change this to:
```rust
let utl_processor: Arc<dyn UtlProcessor> = Arc::new(UtlProcessorAdapter::with_defaults());
```

## Verification Commands

```bash
# 1. Build MCP crate (includes adapter)
cargo build -p context-graph-mcp

# 2. Run adapter tests
cargo test -p context-graph-mcp adapters -- --nocapture

# 3. Verify trait implementation exists
grep -n "impl UtlProcessor for UtlProcessorAdapter" crates/context-graph-mcp/src/adapters/utl_adapter.rs

# 4. Verify no stub usage in adapter
grep -c "StubUtlProcessor" crates/context-graph-mcp/src/adapters/utl_adapter.rs
# Expected: 0

# 5. Verify spawn_blocking usage
grep -c "spawn_blocking" crates/context-graph-mcp/src/adapters/utl_adapter.rs
# Expected: 8

# 6. Count tests
grep -c "#\[tokio::test\]" crates/context-graph-mcp/src/adapters/utl_adapter.rs
# Expected: 11
```

## Full State Verification Protocol

### Source of Truth

The source of truth is the **real UtlProcessor state** accessed via `UtlProcessorAdapter`:
- `processor.lifecycle_stage()` → `lifecycle_phase` in JSON
- `processor.interaction_count()` → `interaction_count` in JSON
- `processor.lambda_weights()` → `lambda_weights.lambda_s/lambda_c`
- `processor.current_phase()` → `phase_angle`
- Accumulated metrics → `entropy`, `coherence`, `learning_score`

### Execute & Inspect Protocol

```rust
// Verification test pattern (already in tests)
let adapter = UtlProcessorAdapter::with_defaults();

// BEFORE: Check initial state
let status_before = adapter.get_status();
assert_eq!(status_before["interaction_count"].as_u64().unwrap(), 0);
assert_eq!(status_before["lifecycle_phase"].as_str().unwrap(), "Infancy");

// Execute computation
let context = UtlContext { goal_vector: Some(vec![0.5; 128]), ..Default::default() };
let _ = adapter.compute_learning_score("test", &context).await;

// AFTER: Verify state changed
let status_after = adapter.get_status();
assert!(status_after["interaction_count"].as_u64().unwrap() >= 1);
```

### Edge Case Coverage (Verified)

| Edge Case | Test | Result |
|-----------|------|--------|
| Empty input string | `test_edge_case_empty_input` | PASS - no panic |
| Empty embedding | `test_adapter_error_propagation` | PASS - graceful handling |
| Lifecycle transition | `test_adapter_lifecycle_progression` | PASS - Infancy→Growth at n=50 |

## Completion Evidence

```
=== M06-T01 VERIFICATION REPORT ===
✓ Trait implementation compiles
✓ All 8 trait methods implemented
✓ get_status() returns valid JSON
✓ Values are LIVE (not hardcoded zeros)
✓ Lifecycle stage transitions correctly (Infancy → Growth at n=50)
✓ interaction_count increments on computation
✓ Error propagation works (no silent failures)
✓ 11 tests pass

LOCATION: crates/context-graph-mcp/src/adapters/utl_adapter.rs
REASON: Avoids cyclic dependency (documented in mod.rs)
```

---

*Task created: 2026-01-04*
*Implementation completed: 2026-01-04*
*Module: 06 - Stub Elimination*
*Layer: Foundation*
*Priority: CRITICAL*
*Status: COMPLETE*
